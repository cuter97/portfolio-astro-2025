---
import { ClientRouter } from "astro:transitions";
import Navbar from "@/components/common/Navbar.astro";
import Footer from "@/components/common/Footer.astro";
import { Toaster } from "@/components/ui/sonner";
import BaseHead from "@/components/BaseHead.astro";

import "../styles/global.css";
import "sonner/dist/styles.css";

const currentLang = Astro.currentLocale || "en";
const { description, image, keys, title } = Astro.props;
---

<!doctype html>
<html lang={currentLang}>
  <head>
    <BaseHead
      title={title}
      description={description}
      image={image}
      keywords={keys}
    />
    <ClientRouter />
    <script is:inline>
      // Script that runs immediately to prevent flickering
      (function () {
        function applyTheme() {
          try {
            var stored = localStorage.getItem("theme");
            var isDark = false;

            if (stored === "dark") {
              isDark = true;
            } else if (stored === "theme-light") {
              isDark = false;
            } else {
              // No stored preference -> follow system
              isDark =
                window.matchMedia &&
                window.matchMedia("(prefers-color-scheme: dark)").matches;
            }

            if (isDark) {
              document.documentElement.classList.add("dark");
            } else {
              document.documentElement.classList.remove("dark");
            }
          } catch (e) {
            // localStorage inaccessible -> use system
            if (
              window.matchMedia &&
              window.matchMedia("(prefers-color-scheme: dark)").matches
            ) {
              document.documentElement.classList.add("dark");
            }
          }
        }

        applyTheme();
      })();
    </script>
  </head>
  <body class="bg-background font-roboto-mono">
    <Navbar />
    <slot />
    <Footer />
    <Toaster client:only="react" position="top-center" richColors />
  </body>
</html>

<script>
  // This script runs after each page transition
  function applyTheme() {
    try {
      const stored = localStorage.getItem("theme");
      let isDark = false;

      if (stored === "dark") {
        isDark = true;
      } else if (stored === "theme-light") {
        isDark = false;
      } else {
        // No stored preference -> follow system
        isDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
      }

      if (isDark) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    } catch (e) {
      // localStorage inaccesible -> use system
      if (
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches
      ) {
        document.documentElement.classList.add("dark");
      }
    }
  }

  applyTheme();
  document.addEventListener("astro:page-load", applyTheme);
</script>
